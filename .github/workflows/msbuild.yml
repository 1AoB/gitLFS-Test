# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: MSBuild

#触发条件：push 或 PR(请求合并) 到 main 分支时运行
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

#SOLUTION_FILE_PATH 指向 .sln
#BUILD_CONFIGURATION: VS 里下拉选择的 Release
env:
  # Path to the solution file relative to the root of the project.
  #SOLUTION_FILE_PATH: .
  SOLUTION_FILE_PATH: gitLFS-Test/gitLFS-Test.sln

  # Configuration type to build.
  # You can convert this to a build matrix if you need coverage of multiple configuration types.
  # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
  BUILD_CONFIGURATION: Release

permissions:
  contents: read

# 步骤：
# actions/checkout@v4：拉取仓库代码（默认不包含 LFS，如果有大文件可改成 with: lfs: true）。
# microsoft/setup-msbuild@v1.0.2：把 MSBuild 加入 PATH，方便后续命令。
# nuget restore ...：根据 .sln/.vcxproj 里的包引用下载 NuGet 包（若项目不依赖 NuGet，可去掉或改用 msbuild /t:Restore）。
# msbuild /m /p:Configuration=Release ...：用 MSBuild 编译解决方案，/m 开多核，Release 配置。
jobs:
  build:
    #windows-latest runner：GitHub 提供的托管 Windows 虚机映像（当前通常是 Windows Server 2022），预装 VS Build Tools、.NET、PowerShell 等。
    #工作流里的所有命令都在这台临时机器上执行，跑完就销毁
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    # 静态检查（可选）：使用 cppcheck，对 src/include 做基础缺陷扫描
    - name: Download cppcheck portable
      run: |
        $version = "2.14.2"
        $zip = "cppcheck-$version-x64.zip"
        Invoke-WebRequest "https://github.com/danmar/cppcheck/releases/download/$version/$zip" -OutFile $zip
        Expand-Archive $zip -DestinationPath cppcheck-portable

    - name: Lint with cppcheck
      run: |
        $cppcheck = Get-ChildItem -Recurse -Filter cppcheck.exe cppcheck-portable | Select-Object -First 1
        if (-not $cppcheck) { Write-Error 'cppcheck.exe not found'; exit 1 }
        $cfg = Join-Path $cppcheck.Directory "cfg"
        if (-not (Test-Path (Join-Path $cfg "std.cfg"))) { Write-Error "std.cfg not found in $cfg"; exit 1 }
        $env:CPPCHECKDATA = $cfg
        & $cppcheck.FullName --enable=all --inconclusive --std=c++17 --force --suppress=missingIncludeSystem gitLFS-Test/src gitLFS-Test/include

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    #GITHUB_WORKSPACE 是 GitHub Actions 默认提供的环境变量，无需在 workflow 里设置
    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}
